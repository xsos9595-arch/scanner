<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” - ×× ×”×œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .login-container {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-header .icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-content h1 {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .header-content p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 15px 30px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab:hover:not(.active) {
            transform: translateY(-2px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-icon {
            font-size: 40px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .chart-container h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-header h2 {
            color: #333;
        }
        
        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .logout-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: white;
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-page">
        <div class="login-container">
            <div class="login-header">
                <div class="icon">ğŸ”</div>
                <h1>×›× ×™×¡×ª ×× ×”×œ</h1>
                <p>×”×–×Ÿ ××ª ×¡×™×¡××ª ×”×× ×”×œ ×›×“×™ ×œ×”××©×™×š</p>
            </div>
            <form id="admin-login-form">
                <div class="form-group">
                    <label for="admin-password">×¡×™×¡××”:</label>
                    <input type="password" id="admin-password" placeholder="×”×›× ×¡ ×¡×™×¡××ª ×× ×”×œ..." required />
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ğŸ”“ ×”×ª×—×‘×¨</button>
            </form>
            <div id="login-error" class="alert alert-error hidden" style="margin-top: 20px;">
                ×¡×™×¡××” ×©×’×•×™×”! × ×¡×” ×©×•×‘.
            </div>
        </div>
    </div>

    <!-- Main Dashboard (Hidden until login) -->
    <div id="main-dashboard" class="hidden">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>ğŸ“Š ×œ×•×— ×‘×§×¨×” - ×× ×”×œ</h1>
                    <p>× ×™×”×•×œ ×¢×•×‘×“×™× ×•××¢×§×‘ ××—×¨ ×™×¦×™××•×ª ××•×¦×¨×™× ××”××—×¡×Ÿ</p>
                </div>
                <button class="logout-btn" onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ×“××©×‘×•×¨×“</button>
                <button class="tab" onclick="switchTab('employees')">ğŸ‘¥ × ×™×”×•×œ ×¢×•×‘×“×™×</button>
                <button class="tab" onclick="switchTab('scans')">ğŸ“¦ ×¡×¨×™×§×•×ª</button>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="controls">
                    <button class="btn btn-primary" onclick="loadData()">ğŸ”„ ×¨×¢× ×Ÿ × ×ª×•× ×™×</button>
                    <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
                </div>
                
                <div id="loading" class="hidden">
                    <div class="spinner"></div>
                </div>
                
                <div id="dashboard-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-icon">ğŸ“¦</div>
                            </div>
                            <div class="stat-value" id="total-products">0</div>
                            <div class="stat-label">×¡×”"×› ××•×¦×¨×™× ×©×•× ×™×</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-icon">ğŸ“Š</div>
                            </div>
                            <div class="stat-value" id="total-quantity">0</div>
                            <div class="stat-label">×¡×”"×› ×™×—×™×“×•×ª ×™×¦××•</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-icon">ğŸ‘¥</div>
                            </div>
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">×¢×•×‘×“×™× ×¤×¢×™×œ×™×</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div class="stat-icon">â°</div>
                            </div>
                            <div class="stat-value" id="last-scan-time">--:--</div>
                            <div class="stat-label">×¡×¨×™×§×” ××—×¨×•× ×”</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h2>××•×¦×¨×™× ××•×‘×™×œ×™× (×œ×¤×™ ×›××•×ª)</h2>
                        <canvas id="topProductsChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <h2>×¤×¢×™×œ×•×ª ×œ×¤×™ ×¢×•×‘×“</h2>
                        <canvas id="userActivityChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-success" onclick="openAddEmployeeModal()">â• ×”×•×¡×£ ×¢×•×‘×“</button>
                    <button class="btn btn-primary" onclick="loadEmployees()">ğŸ”„ ×¨×¢× ×Ÿ ×¨×©×™××”</button>
                </div>
                
                <div class="table-container">
                    <h2>×¨×©×™××ª ×¢×•×‘×“×™×</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>×©×</th>
                                <th>×§×•×“ ×’×™×©×”</th>
                                <th>×¡×˜×˜×•×¡</th>
                                <th>×ª××¨×™×š ×”×•×¡×¤×”</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="employees-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Scans Tab -->
            <div id="scans-tab" class="tab-content">
                <div class="controls">
                    <button class="btn btn-primary" onclick="loadScans()">ğŸ”„ ×¨×¢× ×Ÿ ×¡×¨×™×§×•×ª</button>
                    <button class="btn btn-success" onclick="exportScansToExcel()">ğŸ“¥ ×™×™×¦× ×œ××§×¡×œ</button>
                </div>
                
                <div class="table-container">
                    <h2>×›×œ ×”×¡×¨×™×§×•×ª</h2>
                    <table id="scans-table">
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š ×•×©×¢×”</th>
                                <th>×¢×•×‘×“</th>
                                <th>×§×•×“ ×¢×•×‘×“</th>
                                <th>×‘×¨×§×•×“</th>
                                <th>×›××•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="scans-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Employee Modal -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeEmployeeModal()">&times;</span>
                <h2 id="modal-title">×”×•×¡×£ ×¢×•×‘×“ ×—×“×©</h2>
            </div>
            <form id="employee-form">
                <div class="form-group">
                    <label for="employee-name">×©× ××œ×:</label>
                    <input type="text" id="employee-name" required />
                </div>
                <div class="form-group">
                    <label for="employee-code">×§×•×“ ×’×™×©×”:</label>
                    <input type="text" id="employee-code" required />
                    <small style="color: #666;">×§×•×“ ×‘×Ÿ 4-8 ×ª×•×•×™× (××¡×¤×¨×™×/××•×ª×™×•×ª)</small>
                </div>
                <div class="form-group">
                    <label for="employee-status">×¡×˜×˜×•×¡:</label>
                    <select id="employee-status">
                        <option value="active">×¤×¢×™×œ</option>
                        <option value="inactive">×œ× ×¤×¢×™×œ</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" style="width: 100%;">ğŸ’¾ ×©××•×¨</button>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸ” ×”×’×“×¨×ª ×¡×™×¡××ª ×”×× ×”×œ - ×©× ×” ××ª ×–×”!
        // ============================================
        const ADMIN_PASSWORD = '315806000';  // â† ×©× ×” ××ª ×”×¡×™×¡××” ×›××Ÿ!
        
        // Configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyuNB74JnlAS9KMBLpYvT_hG7pDBWjkRoJjCiB8_20o6d9aUkf50faOI19Wg-MEyl-G/exec';

        
        let allScansData = [];
        let allEmployees = [];
        let topProductsChart = null;
        let userActivityChart = null;
        let editingEmployeeId = null;
        
        // Login handling
        document.getElementById('admin-login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('admin-password').value;
            
            if (password === ADMIN_PASSWORD) {
                // ×¡×™×¡××” × ×›×•× ×” - ×©××•×¨ ×‘-localStorage
                localStorage.setItem('adminLoggedIn', 'true');
                showDashboard();
            } else {
                // ×¡×™×¡××” ×©×’×•×™×”
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('admin-password').value = '';
                
                setTimeout(() => {
                    document.getElementById('login-error').classList.add('hidden');
                }, 3000);
            }
        });
        
        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            
            if (GOOGLE_SCRIPT_URL !== 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
                loadData();
            }
        }
        
        function logout() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?')) {
                localStorage.removeItem('adminLoggedIn');
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('main-dashboard').classList.add('hidden');
                document.getElementById('admin-password').value = '';
            }
        }
        
        // Check if already logged in
        window.addEventListener('load', function() {
            if (localStorage.getItem('adminLoggedIn') === 'true') {
                showDashboard();
            }
        });
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'employees') {
                loadEmployees();
            } else if (tabName === 'scans') {
                loadScans();
            } else if (tabName === 'dashboard') {
                loadData();
            }
        }
        
        // Load dashboard data
        async function loadData() {
            if (GOOGLE_SCRIPT_URL === 'YOUR_GOOGLE_SCRIPT_URL_HERE') {
                alert('× × ×œ×”×’×“×™×¨ ××ª ×›×ª×•×‘×ª Google Apps Script');
                return;
            }
            
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getScans');
                const data = await response.json();
                
                if (data.success) {
                    allScansData = data.scans;
                    processData(data.scans);
                }
                
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('Error:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        function processData(data) {
            if (!data || data.length === 0) {
                return;
            }
            
            const uniqueProducts = new Set(data.map(item => item.barcode)).size;
            const totalQuantity = data.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
            const uniqueUsers = new Set(data.map(item => item.employeeCode)).size;
            
            const lastScan = data[data.length - 1];
            const lastScanTime = new Date(lastScan.timestamp).toLocaleTimeString('he-IL', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            document.getElementById('total-products').textContent = uniqueProducts;
            document.getElementById('total-quantity').textContent = totalQuantity;
            document.getElementById('total-users').textContent = uniqueUsers;
            document.getElementById('last-scan-time').textContent = lastScanTime;
            
            // Group by product
            const productTotals = {};
            data.forEach(item => {
                if (!productTotals[item.barcode]) {
                    productTotals[item.barcode] = 0;
                }
                productTotals[item.barcode] += parseInt(item.quantity || 0);
            });
            
            const sortedProducts = Object.entries(productTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Group by user
            const userTotals = {};
            data.forEach(item => {
                const name = item.employeeName || item.employeeCode;
                if (!userTotals[name]) {
                    userTotals[name] = 0;
                }
                userTotals[name] += parseInt(item.quantity || 0);
            });
            
            updateTopProductsChart(sortedProducts);
            updateUserActivityChart(userTotals);
        }
        
        function updateTopProductsChart(products) {
            const ctx = document.getElementById('topProductsChart').getContext('2d');
            
            if (topProductsChart) {
                topProductsChart.destroy();
            }
            
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: products.map(p => p[0]),
                    datasets: [{
                        label: '×›××•×ª',
                        data: products.map(p => p[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function updateUserActivityChart(users) {
            const ctx = document.getElementById('userActivityChart').getContext('2d');
            
            if (userActivityChart) {
                userActivityChart.destroy();
            }
            
            userActivityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(users),
                    datasets: [{
                        data: Object.values(users),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });
        }
        
        // Employee management
        async function loadEmployees() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getEmployees');
                const data = await response.json();
                
                if (data.success) {
                    allEmployees = data.employees;
                    displayEmployees(data.employees);
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }
        
        function displayEmployees(employees) {
            const tbody = document.getElementById('employees-tbody');
            tbody.innerHTML = '';
            
            employees.forEach(emp => {
                const row = tbody.insertRow();
                const date = new Date(emp.created).toLocaleDateString('he-IL');
                
                row.innerHTML = `
                    <td>${emp.name}</td>
                    <td><code>${emp.code}</code></td>
                    <td><span class="status-badge status-${emp.status}">${emp.status === 'active' ? '×¤×¢×™×œ' : '×œ× ×¤×¢×™×œ'}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="action-btn btn-primary" onclick="editEmployee('${emp.id}')">âœï¸ ×¢×¨×•×š</button>
                        <button class="action-btn btn-${emp.status === 'active' ? 'warning' : 'success'}" onclick="toggleEmployeeStatus('${emp.id}')">
                            ${emp.status === 'active' ? 'ğŸ”’ ×”×©×‘×ª' : 'âœ… ×”×¤×¢×œ'}
                        </button>
                        <button class="action-btn btn-danger" onclick="deleteEmployee('${emp.id}')">ğŸ—‘ï¸ ××—×§</button>
                    </td>
                `;
            });
        }
        
        function openAddEmployeeModal() {
            editingEmployeeId = null;
            document.getElementById('modal-title').textContent = '×”×•×¡×£ ×¢×•×‘×“ ×—×“×©';
            document.getElementById('employee-form').reset();
            document.getElementById('employee-modal').style.display = 'block';
        }
        
        function editEmployee(id) {
            const employee = allEmployees.find(e => e.id === id);
            if (!employee) return;
            
            editingEmployeeId = id;
            document.getElementById('modal-title').textContent = '×¢×¨×•×š ×¢×•×‘×“';
            document.getElementById('employee-name').value = employee.name;
            document.getElementById('employee-code').value = employee.code;
            document.getElementById('employee-status').value = employee.status;
            document.getElementById('employee-modal').style.display = 'block';
        }
        
        function closeEmployeeModal() {
            document.getElementById('employee-modal').style.display = 'none';
        }
        
        document.getElementById('employee-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                action: editingEmployeeId ? 'updateEmployee' : 'addEmployee',
                id: editingEmployeeId,
                name: document.getElementById('employee-name').value,
                code: document.getElementById('employee-code').value,
                status: document.getElementById('employee-status').value
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(editingEmployeeId ? '×”×¢×•×‘×“ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!' : '×”×¢×•×‘×“ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                    closeEmployeeModal();
                    loadEmployees();
                } else {
                    alert(result.message || '×©×’×™××” ×‘×©××™×¨×ª ×”×¢×•×‘×“');
                }
            } catch (error) {
                alert('×©×’×™××”: ' + error.message);
            }
        });
        
        async function toggleEmployeeStatus(id) {
            const employee = allEmployees.find(e => e.id === id);
            if (!employee) return;
            
            const newStatus = employee.status === 'active' ? 'inactive' : 'active';
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateEmployee',
                        id: id,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadEmployees();
                } else {
                    alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡');
                }
            } catch (error) {
                alert('×©×’×™××”: ' + error.message);
            }
        }
        
        async function deleteEmployee(id) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×¢×•×‘×“ ×–×”?')) {
                return;
            }
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deleteEmployee',
                        id: id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('×”×¢×•×‘×“ × ××—×§ ×‘×”×¦×œ×—×”!');
                    loadEmployees();
                } else {
                    alert('×©×’×™××” ×‘××—×™×§×ª ×”×¢×•×‘×“');
                }
            } catch (error) {
                alert('×©×’×™××”: ' + error.message);
            }
        }
        
        // Scans management
        async function loadScans() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=getScans');
                const data = await response.json();
                
                if (data.success) {
                    allScansData = data.scans;
                    displayScans(data.scans);
                }
            } catch (error) {
                console.error('Error loading scans:', error);
            }
        }
        
        function displayScans(scans) {
            const tbody = document.getElementById('scans-tbody');
            tbody.innerHTML = '';
            
            const recentScans = scans.slice(-100).reverse();
            
            recentScans.forEach(scan => {
                const row = tbody.insertRow();
                const date = new Date(scan.timestamp);
                const dateStr = date.toLocaleDateString('he-IL') + ' ' + 
                               date.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
                
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${scan.employeeName || '-'}</td>
                    <td><code>${scan.employeeCode}</code></td>
                    <td>${scan.barcode}</td>
                    <td>${scan.quantity}</td>
                `;
            });
        }
        
        function exportToExcel() {
            if (allScansData.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×');
                return;
            }
            
            const excelData = allScansData.map(item => ({
                '×ª××¨×™×š': new Date(item.timestamp).toLocaleDateString('he-IL'),
                '×©×¢×”': new Date(item.timestamp).toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
                '×¢×•×‘×“': item.employeeName || '-',
                '×§×•×“ ×¢×•×‘×“': item.employeeCode,
                '×‘×¨×§×•×“': item.barcode,
                '×›××•×ª': item.quantity
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "×¡×¨×™×§×•×ª");
            
            const filename = `scans_${new Date().toLocaleDateString('he-IL').replace(/\//g, '-')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
        
        function exportScansToExcel() {
            exportToExcel();
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('employee-modal');
            if (event.target == modal) {
                closeEmployeeModal();
            }
        }
    </script>
</body>
</html>
